<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>داشبورد لایو بازخورد</title>
  <style>
    body{font-family:Tahoma,Arial,sans-serif;margin:0;padding:24px;background:#fff;color:#111}
    h1{font-size:22px;margin:0 0 12px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px;max-width:900px;margin:0 auto}
    .card{border:1px solid #eee;border-radius:14px;padding:16px;box-shadow:0 2px 10px rgba(0,0,0,.04)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 10px;border-bottom:1px solid #f0f0f0;text-align:center}
    tr:last-child td{border-bottom:0}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    input{padding:8px;border:1px solid #ddd;border-radius:8px;width:100px;text-align:center}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid #ddd}
    .ok{background:#f1fff1;border-color:#b8e6b8}
    .warn{background:#fffbe6;border-color:#f5e3a3}
    .bad{background:#fff2f2;border-color:#f1b5b5}
  </style>
</head>
<body>
  <div class="grid">
    <div class="card">
      <h1>داشبورد بازخورد لحظه‌ای</h1>
      <div class="row">
        <div>τ (حداقل رضایت): <input id="tau" value="0.7"></div>
        <div>κ (اطمینان تصمیم): <input id="kappa" value="0.9"></div>
        <div>α₀: <input id="a0" value="1"></div>
        <div>β₀: <input id="b0" value="1"></div>
        <button onclick="refresh()">بروزرسانی</button>
      </div>
    </div>
    <div class="card">
      <table id="tbl">
        <thead>
          <tr><th>بخش</th><th>n</th><th>میانگین</th><th>P(s&lt;τ)</th><th>تصمیم</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="updated" class="pill" style="margin-top:10px">در حال بارگذاری…</div>
    </div>
  </div>
<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyL5eJAPDL1NLXHwcL7r6YwMsFrcwKU-BdjGi4rEM-H9_09LJzpLSb5qUj_LR7hJ00b/exec";

function B(a,b){return Math.exp(lngamma(a)+lngamma(b)-lngamma(a+b));}
// Lanczos approximation for ln(gamma)
function lngamma(z){
  const g=7;
  const p=[0.99999999999980993,676.5203681218851,-1259.1392167224028,771.32342877765313,
           -176.61502916214059,12.507343278686905,-0.13857109526572012,9.9843695780195716e-6,1.5056327351493116e-7];
  if(z<0.5) return Math.log(Math.PI)-Math.log(Math.sin(Math.PI*z))-lngamma(1-z);
  z-=1; let x=p[0]; for(let i=1;i<g+2;i++) x+=p[i]/(z+i);
  let t=z+g+0.5;
  return 0.5*Math.log(2*Math.PI)+(z+0.5)*Math.log(t)-t+Math.log(x)-Math.log(z+1);
}
// Regularized incomplete beta via continued fraction
function betacf(a,b,x){
  const MAXIT=100; const EPS=3e-8; const FPMIN=1e-30;
  let qab=a+b, qap=a+1, qam=a-1, c=1, d=1-qab*x/qap;
  if(Math.abs(d)<FPMIN) d=FPMIN; d=1/d; let h=d;
  for(let m=1, m2=2; m<=MAXIT; m++, m2+=2){
    let aa=m*(b-m)*x/((qam+m2)*(a+m2));
    d=1+aa*d; if(Math.abs(d)<FPMIN) d=FPMIN; c=1+aa/c; if(Math.abs(c)<FPMIN) c=FPMIN; d=1/d; h*=d*c;
    aa=-(a+m)*(qab+m)*x/((a+m2)*(qap+m2));
    d=1+aa*d; if(Math.abs(d)<FPMIN) d=FPMIN; c=1+aa/c; if(Math.abs(c)<FPMIN) c=FPMIN; d=1/d; h*=d*c;
  }
  return h;
}
function ibeta(x,a,b){
  if(x<=0) return 0; if(x>=1) return 1;
  let bt=Math.exp(lngamma(a+b)-lngamma(a)-lngamma(b)+a*Math.log(x)+b*Math.log(1-x));
  if(x < (a+1)/(a+b+2)) return bt*betacf(a,b,x)/a;
  return 1 - bt*betacf(b,a,1-x)/b;
}
async function refresh(){
  const tau=parseFloat(document.getElementById('tau').value);
  const kappa=parseFloat(document.getElementById('kappa').value);
  const a0=parseFloat(document.getElementById('a0').value);
  const b0=parseFloat(document.getElementById('b0').value);
  const updated=document.getElementById('updated');
  updated.textContent='در حال بروزرسانی…';
  try{
    const r=await fetch(WEB_APP_URL+'?summary=true');
    const js=await r.json();
    const tb=document.querySelector('#tbl tbody');
    tb.innerHTML='';
    js.sections.forEach(s=>{
      const alpha=a0+s.sum, beta=b0+(s.n - s.sum);
      const pBelow=ibeta(tau, alpha, beta); // P(S<tau)
      const mean = (s.n>0)? (s.sum/s.n).toFixed(2) : '-';
      const decision = (pBelow>kappa)? 'Refund/Stop & Fix' : 'OK';
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${s.name}</td><td>${s.n}</td><td>${mean}</td><td>${pBelow.toFixed(2)}</td><td>${decision}</td>`;
      if(pBelow>kappa) tr.className='bad'; else if(pBelow>0.5) tr.className='warn'; else tr.className='ok';
      tb.appendChild(tr);
    });
    updated.textContent='آخرین به‌روزرسانی: ' + new Date(js.updated).toLocaleTimeString('fa-IR');
  }catch(e){
    updated.textContent='⛔ خطا در دریافت داده.';
  }
}
refresh();
setInterval(refresh, 5000);
</script>
</body>
</html>
